<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Smart Attendance</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../../assets/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../../assets/js/logout.js"></script>
</head>
<body class="page-dashboard">

    <nav class="navbar navbar-expand-lg navbar-glass fixed-top mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="#"><i class="bi bi-mortarboard-fill"></i> SmartAttend</a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
                <ul class="navbar-nav gap-3">
                    <li class="nav-item"><a class="nav-link active-view" onclick="switchView('dashboard', this)">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="switchView('timetable', this)">Timetable</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="switchView('reports', this)">Reports</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="switchView('notices', this)">Notices <span class="badge bg-danger rounded-circle small">2</span></a></li>
                </ul>
            </div>

            <div class="d-none d-lg-flex align-items-center gap-3">
                <div class="dropdown me-2">
                    <button class="btn btn-light position-relative" data-bs-toggle="dropdown" title="Notifications">
                        <i class="bi bi-bell fs-5"></i>
                        <span id="notifBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end p-2 shadow" style="min-width: 260px;">
                        <li class="fw-bold ps-2">Notifications</li>
                        <li><hr class="dropdown-divider"></li>
                        <div id="notifList" style="max-height:220px; overflow:auto;"></div>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-center small text-primary" href="#" onclick="clearNotifications()">Clear All</a></li>
                    </ul>
                </div>

                <div class="dropdown">
                    <button class="btn btn-light rounded-circle p-0" style="width: 40px; height: 40px; overflow: hidden;" data-bs-toggle="dropdown">
                        <img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?auto=format&fit=crop&w=100&q=80" class="w-100 h-100 object-fit-cover" alt="Profile">
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="switchView('profile')">Profile & Settings</a></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="handleLogout(event)">Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 90px;">

        <div class="row mb-4">
            <div class="col-12">
                    <div class="glass-card p-4 d-flex flex-column flex-md-row align-items-center">
                    <a onclick="switchView('profile')" style="text-decoration:none; color:inherit; display:flex; align-items:center; gap:1rem;">
                        <img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?auto=format&fit=crop&w=200&q=80" alt="Profile" class="profile-photo mb-3 mb-md-0 me-md-4">
                        <div class="text-center text-md-start">
                            <h2 class="fw-bold text-dark mb-1">Welcome, KSHITIJ PATEL</h2>
                            <p class="text-secondary mb-0 fw-bold">BE-CSE-3rd Sem | Roll No: 2025001</p>
                            <small class="text-muted" id="currentDateDisplay">Loading Date...</small>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- Low attendance banner (hidden by default) -->
        <div id="lowAttendanceBanner" class="d-none container mb-3">
            <div class="glass-card p-3 border-start border-4 border-danger">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="fw-bold text-danger mb-1">Low Attendance Warning</h6>
                        <small id="lowAttendanceText" class="text-muted">You have low attendance in one or more subjects.</small>
                    </div>
                    <div><button class="btn btn-danger btn-sm" onclick="switchView('reports', document.querySelector('.nav-link[onclick*=reports]'))">View Reports</button></div>
                </div>
            </div>
        </div>

        <div id="dashboard" class="view-section active">
            <div class="row g-4">
                <div class="col-lg-4">
                    <div class="glass-card p-4 h-100 text-center">
                        <h5 class="fw-bold text-secondary mb-4">Overall Status</h5>
                        <div class="percentage-circle mb-3"></div>
                        <h4 class="mb-1 text-success fw-bold">Excellent!</h4>
                        <p class="text-muted small">You are safe above 75%.</p>
                        <hr class="my-4 opacity-25">
                        <div class="d-flex justify-content-between px-3">
                            <div><h5 class="fw-bold mb-0">45</h5><small class="text-muted">Present</small></div>
                            <div><h5 class="fw-bold mb-0">53</h5><small class="text-muted">Total</small></div>
                            <div><h5 class="fw-bold text-danger mb-0">8</h5><small class="text-muted">Absent</small></div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-8">
                    <div class="glass-card p-4 h-100">
                        <h5 class="fw-bold text-secondary mb-4"><i class="bi bi-graph-up-arrow me-2"></i>Subject Performance</h5>
                        <div class="vstack gap-4">
                            <div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="fw-bold">Operating Systems</span><span class="fw-bold text-warning">72%</span>
                                </div>
                                <div class="progress" style="height: 8px;"><div class="progress-bar bg-warning" style="width: 72%"></div></div>
                            </div>
                            <div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="fw-bold">Data Structures</span><span class="fw-bold text-success">90%</span>
                                </div>
                                <div class="progress" style="height: 8px;"><div class="progress-bar bg-success" style="width: 90%"></div></div>
                            </div>
                            <div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="fw-bold">Mathematics III</span><span class="fw-bold text-success">88%</span>
                                </div>
                                <div class="progress" style="height: 8px;"><div class="progress-bar bg-success" style="width: 88%"></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4 mt-2">
                <div class="col-lg-4">
                    <div class="glass-card p-3 h-100">
                        <h6 class="fw-bold text-secondary">Next Up</h6>
                        <div id="nextUp" class="mt-3">
                            <div class="text-muted small">Loading next class...</div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-8">
                    <div class="glass-card p-3 h-100">
                        <h6 class="fw-bold text-secondary">Recent Activity</h6>
                        <ul id="activityFeed" class="list-group list-group-flush mt-3 small">
                            <li class="list-group-item">No recent activity</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-12">
                    <div class="glass-card p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="fw-bold text-secondary mb-0"><i class="bi bi-clock-history me-2"></i>Today's Schedule</h5>
                            <span class="badge bg-primary rounded-pill px-3" id="dayBadge">Today</span>
                        </div>
                        <div class="table-responsive">
                            <table class="table align-middle mb-0">
                                <thead class="table-light rounded">
                                    <tr>
                                        <th>Time</th>
                                        <th>Subject</th>
                                        <th>Status</th>
                                        <th>Location</th>
                                        <th class="text-end">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="scheduleTableBody">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="timetable" class="view-section">
            <div class="row">
                <div class="col-12">
                    <div class="glass-card p-4">
                        <h4 class="fw-bold text-secondary mb-4"><i class="bi bi-calendar-week me-2"></i>Class Timetable</h4>
                        
                        <ul class="nav nav-pills mb-3 d-lg-none" id="pills-tab" role="tablist">
                            <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-mon">Mon</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-tue">Tue</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-wed">Wed</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-thu">Thu</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-fri">Fri</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-sat">Sat</button></li>
                        </ul>

                        <div class="row g-3" id="timetableGrid">
                            </div>
                        
                        <div class="d-lg-none tab-content" id="timetableMobileTabs">
                             </div>

                    </div>
                </div>
            </div>
        </div>

        <div id="notices" class="view-section">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="glass-card p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4 class="fw-bold text-secondary mb-0"><i class="bi bi-megaphone me-2"></i>Notice Board</h4>
                            <button class="btn btn-sm btn-outline-secondary"><i class="bi bi-funnel"></i> Filter</button>
                        </div>

                        <div class="notice-item urgent">
                            <div class="d-flex justify-content-between">
                                <h6 class="fw-bold mb-1 text-danger">Mid-Semester Examination Schedule</h6>
                                <span class="badge bg-danger bg-opacity-10 text-danger">Urgent</span>
                            </div>
                            <p class="mb-1 small">The Mid-Sem exams for CSE 3rd Sem will commence from Oct 15th.</p>
                            <div class="notice-date"><i class="bi bi-calendar3"></i> Posted: Dec 20, 2025</div>
                        </div>

                        <div class="notice-item">
                            <div class="d-flex justify-content-between">
                                <h6 class="fw-bold mb-1">Holiday Announcement</h6>
                                <span class="badge bg-primary bg-opacity-10 text-primary">Info</span>
                            </div>
                            <p class="mb-1 small">College will remain closed on Friday, Dec 25th for Christmas.</p>
                            <div class="notice-date"><i class="bi bi-calendar3"></i> Posted: Dec 19, 2025</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="reports" class="view-section">
            <div class="glass-card p-3 mb-4 d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0 ps-2">Attendance Analytics</h5>
                <div class="btn-group" role="group">
                    <button class="btn btn-primary" onclick="updateReport('weekly', this)">Weekly</button>
                    <button class="btn btn-outline-primary" onclick="updateReport('monthly', this)">Monthly</button>
                    <button class="btn btn-outline-primary" onclick="updateReport('overall', this)">Overall</button>
                </div>
            </div>
            
            <div class="row g-4 mb-4">
                <div class="col-lg-8"><div class="glass-card p-4"><canvas id="trendChart" height="150"></canvas></div></div>
                <div class="col-lg-4"><div class="glass-card p-4 h-100"><canvas id="subjectChart" height="250"></canvas></div></div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="glass-card p-4">
                        <h6 class="fw-bold text-secondary mb-3">Detailed Subject Report</h6>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Subject Name</th>
                                        <th>Total Classes</th>
                                        <th>Attended</th>
                                        <th>Absent</th>
                                        <th>Attendance %</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="reportTableBody">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student Profile View -->
        <div id="profile" class="view-section">
            <div class="row g-4">
                <div class="col-lg-7">
                    <div class="glass-card p-4">
                        <div class="d-flex flex-column align-items-center text-center">
                            <img id="profilePhoto" src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?auto=format&fit=crop&w=400&q=80" alt="Profile" style="width:140px;height:140px;border-radius:50%;object-fit:cover;border:4px solid white;box-shadow:0 6px 24px rgba(0,0,0,0.15);">
                            <h3 id="pfName" class="fw-bold mt-3 mb-1">Kshitij Patel</h3>
                            <div id="pfCourse" class="small text-muted mb-2">BE - CSE • 3rd Sem</div>
                            <button class="btn btn-sm btn-outline-primary mb-3" onclick="alert('Contact Admin to change details')"><i class="bi bi-pencil-square me-1"></i>Edit Profile</button>
                        </div>

                        <hr>
                        <div class="row">
                            <div class="col-6">
                                <h6 class="fw-bold small text-secondary">Date of Birth</h6>
                                <div id="pfDOB">-</div>
                            </div>
                            <div class="col-3">
                                <h6 class="fw-bold small text-secondary">Gender</h6>
                                <div id="pfGender">-</div>
                            </div>
                            <div class="col-3">
                                <h6 class="fw-bold small text-secondary">Blood Group</h6>
                                <div id="pfBlood">-</div>
                            </div>
                        </div>

                        <hr>
                        <div>
                            <h6 class="fw-bold small text-secondary">Family</h6>
                            <div class="row">
                                <div class="col-6"><small class="text-muted">Father</small><div id="pfFather">-</div></div>
                                <div class="col-6"><small class="text-muted">Mother</small><div id="pfMother">-</div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-5">
                    <div class="glass-card p-4">
                        <h6 class="fw-bold text-secondary">Academic Details</h6>
                        <div class="mt-3 small text-muted">Identifiers</div>
                        <div class="row mt-2">
                            <div class="col-12"><strong>Admission No:</strong> <span id="pfAdmission">-</span></div>
                            <div class="col-12"><strong>Roll No:</strong> <span id="pfRoll">-</span></div>
                            <div class="col-12"><strong>University Reg. ID:</strong> <span id="pfReg">-</span></div>
                        </div>

                        <hr>
                        <div class="small text-muted">Course Info</div>
                        <div class="mt-2">
                            <div><strong>Degree:</strong> <span id="pfDegree">-</span></div>
                            <div><strong>Branch:</strong> <span id="pfBranch">-</span></div>
                            <div><strong>Semester:</strong> <span id="pfSemester">-</span></div>
                            <div><strong>Batch:</strong> <span id="pfBatch">-</span></div>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="glass-card p-4">
                        <h6 class="fw-bold text-secondary">Contact & Location</h6>
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <div class="small text-muted">College Email</div>
                                <div id="pfEmailCollege">-</div>
                                <div class="small text-muted mt-2">Personal Email</div>
                                <div id="pfEmailPersonal">-</div>
                            </div>
                            <div class="col-md-4">
                                <div class="small text-muted">Phone</div>
                                <div id="pfPhone">-</div>
                            </div>
                            <div class="col-md-4">
                                <div class="small text-muted">Current Address</div>
                                <div id="pfAddressCurrent">-</div>
                            </div>
                        </div>

                        <hr>
                        <div>
                            <div class="small text-muted">Permanent Address</div>
                            <div id="pfAddressPermanent">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Profile & Settings Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 12px;">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">Profile & Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex gap-3 align-items-center mb-3">
                        <img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?auto=format&fit=crop&w=200&q=80" class="profile-photo">
                        <div>
                            <div class="fw-bold">KSHITIJ PATEL</div>
                            <div class="small text-muted">Roll No: 2025001 • BE-CSE • 3rd Sem</div>
                        </div>
                    </div>

                    <hr>
                    <h6 class="fw-bold small text-secondary">Preferences</h6>
                    <div class="form-check form-switch mt-2">
                        <input class="form-check-input" type="checkbox" id="darkModeToggle" onchange="toggleDarkMode(this)">
                        <label class="form-check-label small" for="darkModeToggle">Dark Mode</label>
                    </div>
                    <div class="form-check form-switch mt-2">
                        <input class="form-check-input" type="checkbox" id="emailNotifToggle">
                        <label class="form-check-label small" for="emailNotifToggle">Email Notifications</label>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button class="btn btn-primary" onclick="saveSettings()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="cameraModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">Attendance Verification</h5>
                    <button type="button" class="btn-close" onclick="closeCamera()"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="text-muted small mb-2">Subject: <span id="modalSubject" class="text-primary fw-bold"></span></p>
                    <div id="locationStep" class="mb-3 p-2 bg-light rounded">
                        <div class="d-flex align-items-center justify-content-center gap-2">
                             <div class="spinner-border spinner-border-sm text-primary" id="locSpinner"></div>
                             <span id="locStatusText" class="small fw-bold">Verifying Geofence (15m)...</span>
                        </div>
                        <small id="distanceDisplay" class="d-block text-muted mt-1" style="font-size: 0.75rem;"></small>
                    </div>
                    <div id="cameraContainer" style="display: none; position: relative;">
                        <video id="videoElement" autoplay playsinline></video>
                        <div class="position-absolute bottom-0 start-50 translate-middle-x mb-3">
                            <button class="btn btn-light rounded-circle shadow" style="width: 50px; height: 50px;" onclick="takeSnapshot()"><i class="bi bi-camera-fill fs-4"></i></button>
                        </div>
                        <canvas id="canvas" style="display: none;"></canvas>
                        <img id="photo" style="display: none; width: 100%; border-radius: 10px;">
                    </div>
                    <div id="errorMsg" class="alert alert-danger small mt-2 d-none"></div>
                </div>
                <div class="modal-footer border-0 justify-content-center pt-0">
                    <button class="btn btn-primary rounded-pill px-4" id="submitBtn" disabled onclick="finalizeAttendance()">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // CONFIG
        const COLLEGE_LAT = 21.2500;
        const COLLEGE_LNG = 81.6300;
        const ALLOWED_RADIUS = 15; // 15 Meters

        // FULL WEEKLY SCHEDULE
        const fullTimetable = {
            "Monday": ["OS (09-10)", "M3 (10-11)", "DELD (11-12)", "Break (12-01)", "PPL (01-02)", "SS (02-03)"],
            "Tuesday": ["SS (09-10)", "TT (10-11)", "Break", "DSA/DELD Lab (01-03)", "OS (03-04)"],
            "Wednesday": ["DSA (09-10)", "OS/SCI Lab (10-11)", "DELD (11-12)", "Break", "TT (01-02)", "M3 (02-03)", "Seminar (03-04)"],
            "Thursday": ["TT (09-10)", "DSA (10-11)", "Break", "PPL (01-02)", "OS/SCI Lab (02-03)", "DELD (03-04)"],
            "Friday": ["M3 (09-10)", "DSA/DELD Lab (10-12)", "Break", "DSA (01-02)", "SS (02-03)", "TT (03-04)"],
            "Saturday": ["PPL (09-10)", "OS (10-11)", "DELD (11-12)", "Break", "OS (01-02)"]
        };

        // SCHEDULE FOR DASHBOARD
        const weeklySchedule = {
            "Monday": [{t:"09:00", s:"OS", r:"Hall A", st:"Pending"}, {t:"10:00", s:"M3", r:"Hall A", st:"Pending"}, {t:"11:00", s:"DELD", r:"TB 11", st:"Present"}],
            "Tuesday": [{t:"09:00", s:"SS", r:"TB 11", st:"Pending"}, {t:"13:00", s:"Lab", r:"Lab 1", st:"Pending"}],
            "Wednesday": [{t:"09:00", s:"DSA", r:"TB 11", st:"Pending"}, {t:"11:00", s:"DELD", r:"TB 11", st:"Pending"}],
            "Thursday": [{t:"10:00", s:"DSA", r:"TB 11", st:"Pending"}, {t:"14:00", s:"OS Lab", r:"Lab 2", st:"Pending"}],
            "Friday": [{t:"09:00", s:"M3", r:"Hall A", st:"Pending"}, {t:"10:00", s:"Lab", r:"Lab 2", st:"Pending"}],
            "Saturday": [{t:"09:00", s:"PPL", r:"TB 11", st:"Pending"}]
        };

        // REPORT DATA (mock) - configure OS as low to trigger warnings
        const reportData = {
            weekly: { l: ["Mon","Tue","Wed","Thu","Fri"], d: [100,80,100,60,90], s: [{n:"OS", t:4, a:2}, {n:"M3", t:4, a:4}] },
            monthly: { l: ["W1","W2","W3","W4"], d: [72,68,70,75], s: [{n:"OS", t:16, a:10}, {n:"M3", t:16, a:14}] },
            overall: { l: ["Aug","Sep","Oct","Nov"], d: [70,72,74,76], s: [{n:"OS", t:40, a:24}, {n:"M3", t:40, a:38}, {n:"DELD", t:35, a:30}] }
        };

        // Activity / Notifications / History (mock storage)
        const activityLog = [
            {t: '10:05 AM', msg: 'Marked Present in OS'},
            {t: '09:20 AM', msg: 'Viewed Timetable'},
            {t: '08:55 AM', msg: 'Checked Notifications'}
        ];
        const notifications = [
            {t:'Dec 22', msg: 'Holiday tomorrow'},
        ];
        const attendanceHistory = [
            {date:'2025-12-21', subject:'OS', status:'Absent'},
            {date:'2025-12-20', subject:'M3', status:'Present'}
        ];

        // STUDENT PROFILE MOCK DATA
        const studentProfile = {
            name: 'Kshitij Patel',
            photo: 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?auto=format&fit=crop&w=400&q=80',
            dob: '2005-06-12',
            gender: 'Male',
            blood: 'O+',
            father: 'Ramesh Patel',
            mother: 'Sonal Patel',
            admissionNo: '20230015',
            rollNo: '2025001',
            regId: 'UNI2023CSE0015',
            degree: 'B.E.',
            branch: 'CSE',
            semester: '3rd',
            batch: '2024-2028',
            collegeEmail: 'kshitij.patel@college.edu',
            personalEmail: 'kshitij.patel@gmail.com',
            phone: '+91-9876543210',
            addressCurrent: '123, Hostel Road, College City',
            addressPermanent: '45, Patel Street, Hometown'
        };

        let currentButton=null, videoStream=null, trendChart=null, subChart=null;
        const modalObj = new bootstrap.Modal(document.getElementById('cameraModal'));

        window.onload = function() {
            document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString();
            loadDashboardSchedule();
            renderTimetable();
            updateReport('weekly', document.querySelector('#reports .btn-primary'));
            updateActivityFeed();
            showNotifications();
            checkLowAttendance();
            populateAttendanceHistory();
            // restore settings
            const dm = localStorage.getItem('darkMode') === '1';
            if(document.getElementById('darkModeToggle')) { document.getElementById('darkModeToggle').checked = dm; if(dm) toggleDarkMode({checked:true}); }
            const en = localStorage.getItem('emailNotif') === '1';
            if(document.getElementById('emailNotifToggle')) document.getElementById('emailNotifToggle').checked = en;
        };

        // VIEW SWITCHER
        function switchView(id, link) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            const target = document.getElementById(id);
            if(!target) return;
            target.classList.add('active');
            // manage nav active state only when a navbar link is provided
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active-view'));
            if(link && link.classList && link.classList.contains('nav-link')) link.classList.add('active-view');
            // if showing profile view, render it
            if(id === 'profile') renderProfile();
        }

        // RENDER DASHBOARD SCHEDULE
        function loadDashboardSchedule() {
            const days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
            let today = days[new Date().getDay()];
            if(today === "Sunday") today = "Monday"; // Demo
            document.getElementById('dayBadge').innerText = today;

            const list = weeklySchedule[today] || [];
            const tbody = document.getElementById('scheduleTableBody');
            tbody.innerHTML = '';

            const now = new Date();
            const nowMinutes = now.getHours()*60 + now.getMinutes();
            let activeIndex = -1, nextIndex = -1;

            if(list.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5"><div class="no-data"><i class="bi bi-calendar-x icon"></i><div>No classes scheduled today</div></div></td></tr>`;
            }

            list.forEach((item, idx) => {
                const [hh,mm] = item.t.split(':').map(x=>parseInt(x));
                const itemMinutes = (isNaN(hh)?0:hh)*60 + (isNaN(mm)?0:mm);
                if(itemMinutes <= nowMinutes && (nowMinutes - itemMinutes) < 60) activeIndex = idx;
                if(itemMinutes > nowMinutes && nextIndex === -1) nextIndex = idx;
            });

            list.forEach((item, idx) => {
                const isPending = item.st === "Pending";
                const isActive = idx === activeIndex;
                const isNext = idx === nextIndex;
                tbody.innerHTML += `
                    <tr class="${isActive?'table-primary':''}">
                        <td class="fw-bold text-secondary">${item.t}${isActive?'<small class="text-success"> (Ongoing)</small>':''}</td>
                        <td><div class="fw-bold">${item.s}${isNext? ' <small class="text-muted">(Next)</small>':''}</div><small class="text-muted"><i class="bi bi-geo-alt"></i> ${item.r}</small></td>
                        <td><span class="badge ${isPending?'bg-secondary':'bg-success'} rounded-pill badge-status">${item.st}</span></td>
                        <td class="small text-muted loc-info">-</td>
                        <td class="text-end">
                            <button class="btn ${isPending?'btn-primary':'btn-success'} btn-sm rounded-pill px-3" ${!isPending?'disabled':''} onclick="initAtt('${item.s}',this)">
                                ${isPending?'Mark':'<i class="bi bi-check2"></i> Marked'}
                            </button>
                        </td>
                    </tr>`;
            });

            const nextEl = document.getElementById('nextUp');
            if(nextIndex !== -1 && list[nextIndex]) {
                nextEl.innerHTML = `<div class="fw-bold">${list[nextIndex].s}</div><div class="small text-muted">${list[nextIndex].t} • ${list[nextIndex].r}</div>`;
            } else nextEl.innerHTML = `<div class="text-muted small">No more classes today</div>`;
        }

        // RENDER FULL TIMETABLE
        function renderTimetable() {
            const container = document.getElementById('timetableGrid');
            const mobileContainer = document.getElementById('timetableMobileTabs');
            
            for(const [day, subjects] of Object.entries(fullTimetable)) {
                let html = `<div class="col-md-6 col-lg-4 mb-3"><div class="border rounded bg-white h-100 shadow-sm">
                    <div class="timetable-day-header">${day}</div><div class="p-2">`;
                subjects.forEach(sub => html += `<div class="timetable-row small"><i class="bi bi-dot text-primary"></i> ${sub}</div>`);
                html += `</div></div></div>`;
                container.innerHTML += html;

                let mHtml = `<div class="tab-pane fade ${day==='Monday'?'show active':''}" id="tab-${day.toLowerCase().slice(0,3)}">
                    <div class="bg-white p-3 rounded shadow-sm">`;
                subjects.forEach(sub => mHtml += `<div class="p-2 border-bottom"><span class="fw-bold text-dark">${sub.split('(')[0]}</span> <span class="float-end badge bg-light text-dark">${sub.split('(')[1]||''}</span></div>`);
                mHtml += `</div></div>`;
                mobileContainer.innerHTML += mHtml;
            }
        }

        // ATTENDANCE & GEO
        function initAtt(sub, btn) {
            currentButton = btn;
            document.getElementById('modalSubject').innerText = sub;
            document.getElementById('cameraContainer').style.display='none';
            document.getElementById('locationStep').style.display='block';
            document.getElementById('errorMsg').classList.add('d-none');
            document.getElementById('submitBtn').disabled=true;
            document.getElementById('photo').style.display='none';
            document.getElementById('videoElement').style.display='block';
            modalObj.show();
            verifyLoc();
        }

        function verifyLoc() {
            const spin = document.getElementById('locSpinner');
            const txt = document.getElementById('locStatusText');
            if(!navigator.geolocation) { showError("GPS Missing"); return; }

            navigator.geolocation.getCurrentPosition(pos => {
                const dist = getDist(pos.coords.latitude, pos.coords.longitude, COLLEGE_LAT, COLLEGE_LNG);
                document.getElementById('distanceDisplay').innerText = `Dist: ${Math.round(dist)}m`;
                
                if(dist <= ALLOWED_RADIUS) {
                    spin.className = "bi bi-check-circle-fill text-success fs-5";
                    txt.className = "text-success fw-bold"; txt.innerText = "Location Verified!";
                    setTimeout(startCam, 1000);
                } else {
                    spin.className = "bi bi-x-circle-fill text-danger fs-5";
                    txt.className = "text-danger fw-bold"; txt.innerText = "Outside Geofence";
                    showError(`Too far (${Math.round(dist)}m). Move inside campus.`);
                }
            }, () => showError("GPS Denied"));
        }

        function getDist(lat1,lon1,lat2,lon2) {
            const R=6371e3; const φ1=lat1*Math.PI/180; const φ2=lat2*Math.PI/180;
            const Δφ=(lat2-lat1)*Math.PI/180; const Δλ=(lon2-lon1)*Math.PI/180;
            const a=Math.sin(Δφ/2)*Math.sin(Δφ/2)+Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)*Math.sin(Δλ/2);
            return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
        }

        async function startCam() {
            document.getElementById('locationStep').style.display='none';
            document.getElementById('cameraContainer').style.display='block';
            try { videoStream = await navigator.mediaDevices.getUserMedia({video:true}); document.getElementById('videoElement').srcObject=videoStream; }
            catch { showError("Cam Access Denied"); }
        }

        function takeSnapshot() {
            const v = document.getElementById('videoElement'); const c = document.getElementById('canvas');
            c.width=v.videoWidth; c.height=v.videoHeight; c.getContext('2d').drawImage(v,0,0);
            document.getElementById('photo').src=c.toDataURL('image/png');
            v.style.display='none'; document.getElementById('photo').style.display='block';
            document.getElementById('submitBtn').disabled=false;
        }

        function finalizeAttendance() {
            const r = currentButton.closest('tr');
            r.querySelector('.badge-status').className="badge bg-success rounded-pill badge-status";
            r.querySelector('.badge-status').innerText="Present";
            r.querySelector('.loc-info').innerHTML=`<i class="bi bi-geo-fill text-success"></i> Verified`;
            currentButton.className="btn btn-success btn-sm rounded-pill px-3";
            currentButton.innerHTML='<i class="bi bi-check2"></i> Marked';
            currentButton.disabled=true;

            const subj = document.getElementById('modalSubject').innerText || 'Subject';
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            activityLog.unshift({t: timeStr, msg: `Marked Present in ${subj}`});
            if(activityLog.length>10) activityLog.pop();
            attendanceHistory.unshift({date: now.toISOString().slice(0,10), subject: subj, status: 'Present'});
            if(attendanceHistory.length>50) attendanceHistory.pop();
            updateActivityFeed();
            addNotification(`${subj} marked present at ${timeStr}`);

            // show animated success feedback, vibrate on supported devices
            showSuccessMessage('Marked Present', () => {
                populateAttendanceHistory();
                closeCamera();
            });
        }

        function closeCamera() { if(videoStream)videoStream.getTracks().forEach(t=>t.stop()); modalObj.hide(); }
        function showError(m) { const e=document.getElementById('errorMsg'); e.innerText=m; e.classList.remove('d-none'); }

        // Generic chart creator
        const createChart = (canvasId, type, data, options={}) => new Chart(document.getElementById(canvasId), Object.assign({type, data}, options));

        // UPDATED REPORTS FUNCTION
        function updateReport(type, btn) {
            btn.parentElement.querySelectorAll('.btn').forEach(b=>{b.classList.remove('btn-primary');b.classList.add('btn-outline-primary')});
            btn.classList.remove('btn-outline-primary'); btn.classList.add('btn-primary');
            const d = reportData[type];
            
            // 1. Charts (use generic helper)
            if(trendChart) trendChart.destroy();
            trendChart = createChart('trendChart','line',{labels:d.l,datasets:[{label:'Attendance %',data:d.d,borderColor:'#0d6efd',fill:true,backgroundColor:'rgba(13,110,253,0.1)'}]});
            if(subChart) subChart.destroy();
            subChart = createChart('subjectChart','doughnut',{labels:d.s.map(x=>x.n),datasets:[{data:d.s.map(x=>x.a),backgroundColor:['#198754','#ffc107','#0dcaf0']} ]});

            // 2. Populate Detailed Table (The Fix)
            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = '';
            
            d.s.forEach(sub => {
                const pct = Math.round((sub.a / sub.t) * 100);
                const statusBadge = pct >= 75 
                    ? '<span class="badge bg-success">Safe</span>' 
                    : '<span class="badge bg-danger">Low</span>';
                
                tbody.innerHTML += `
                    <tr>
                        <td class="fw-bold">${sub.n}</td>
                        <td>${sub.t}</td>
                        <td>${sub.a}</td>
                        <td>${sub.t - sub.a}</td>
                        <td class="fw-bold ${pct<75?'text-danger':'text-success'}">${pct}%</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            });
        }

        // Activity & Notifications helpers
        function updateActivityFeed() {
            const ul = document.getElementById('activityFeed');
            ul.innerHTML = '';
            const items = activityLog.slice(0,3);
            if(items.length===0) { ul.innerHTML = '<li class="list-group-item">No recent activity</li>'; return; }
            items.forEach(it => {
                const li = document.createElement('li'); li.className='list-group-item';
                li.innerHTML = `<div class="d-flex justify-content-between"><div>${it.msg}</div><div class="text-muted small">${it.t}</div></div>`;
                ul.appendChild(li);
            });
        }

        function addNotification(msg) {
            notifications.unshift({t: new Date().toLocaleDateString(), msg});
            if(notifications.length>20) notifications.pop();
            showNotifications();
        }

        function showNotifications() {
            const list = document.getElementById('notifList');
            const badge = document.getElementById('notifBadge');
            list.innerHTML = '';
            if(notifications.length===0) { list.innerHTML = '<div class="small text-muted p-2">No notifications</div>'; badge.innerText = '0'; return; }
            notifications.slice(0,8).forEach(n => {
                const el = document.createElement('div'); el.className='px-2 py-1';
                el.innerHTML = `<div class="small"><strong>${n.msg}</strong></div><div class="small text-muted">${n.t}</div><hr class="my-1">`;
                list.appendChild(el);
            });
            badge.innerText = notifications.length;
        }

        function clearNotifications() { notifications.length=0; showNotifications(); }

        // Reports helpers: download CSV and show history
        function exportCSV() {
            const rows = [['Date','Subject','Status']];
            attendanceHistory.forEach(r => rows.push([r.date, r.subject, r.status]));
            let csv = rows.map(r => r.map(c => '"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
            const blob = new Blob([csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'attendance_history.csv'; a.click(); URL.revokeObjectURL(url);
        }

        function populateAttendanceHistory() {
            let hist = document.getElementById('attendanceHistoryList');
            if(!hist) {
                const div = document.createElement('div'); div.className='mt-3';
                div.innerHTML = '<div class="d-flex justify-content-between align-items-center"><h6 class="mb-0">Attendance History</h6><button class="btn btn-sm btn-outline-secondary" onclick="exportCSV()">Download CSV</button></div><ul id="attendanceHistoryList" class="list-group mt-2 small"></ul>';
                document.querySelector('#reports .glass-card')?.after(div);
                hist = document.getElementById('attendanceHistoryList');
            }
            hist.innerHTML='';
            if(attendanceHistory.length === 0) {
                hist.innerHTML = '<li class="list-group-item"><div class="no-data"><i class="bi bi-clock-history icon"></i><div>No attendance history</div></div></li>';
                return;
            }
            attendanceHistory.slice(0,10).forEach(h => {
                const li = document.createElement('li'); li.className='list-group-item d-flex justify-content-between';
                li.innerHTML = `<div>${h.subject}</div><div class="text-muted">${h.date} • ${h.status}</div>`;
                hist.appendChild(li);
            });
        }

        // Success overlay helper — creates temporary checked popup + optional vibration
        function showSuccessMessage(text, cb) {
            try { if(navigator.vibrate) navigator.vibrate(200); } catch(e){}
            const wrap = document.createElement('div'); wrap.className = 'success-overlay';
            wrap.innerHTML = `<div class="check-pop show"><div class="check"><i class="bi bi-check2-circle"></i></div><div class="text"><strong>${text}</strong></div></div>`;
            document.body.appendChild(wrap);
            setTimeout(() => { wrap.classList.add('removing'); }, 1200);
            setTimeout(() => { if(wrap.parentNode) wrap.parentNode.removeChild(wrap); if(cb) cb(); }, 1500);
        }

        // Render profile into profile view (mapping loop)
        function renderProfile() {
            try {
                const map = {
                    profilePhoto: 'photo',
                    pfName: 'name',
                    pfDOB: 'dob',
                    pfGender: 'gender',
                    pfBlood: 'blood',
                    pfFather: 'father',
                    pfMother: 'mother',
                    pfAdmission: 'admissionNo',
                    pfRoll: 'rollNo',
                    pfReg: 'regId',
                    pfDegree: 'degree',
                    pfBranch: 'branch',
                    pfSemester: 'semester',
                    pfBatch: 'batch',
                    pfEmailCollege: 'collegeEmail',
                    pfEmailPersonal: 'personalEmail',
                    pfPhone: 'phone',
                    pfAddressCurrent: 'addressCurrent',
                    pfAddressPermanent: 'addressPermanent'
                };
                // photo & course handled specially
                document.getElementById('profilePhoto').src = studentProfile.photo;
                document.getElementById('pfCourse').innerText = `${studentProfile.degree} - ${studentProfile.branch} • ${studentProfile.semester}`;
                Object.entries(map).forEach(([id,key])=>{
                    const el=document.getElementById(id); if(!el) return;
                    el.innerText = key==='dob' ? new Date(studentProfile[key]).toLocaleDateString() : (studentProfile[key]||'-');
                });
            } catch(e){console.warn('Profile render error',e)}
        }

        function checkLowAttendance() {
            const low = reportData.overall.s.filter(s => Math.round((s.a/s.t)*100) < 75);
            const banner = document.getElementById('lowAttendanceBanner');
            const text = document.getElementById('lowAttendanceText');
            if(low.length>0) {
                banner.classList.remove('d-none');
                text.innerText = `Low attendance in: ${low.map(x=>x.n).join(', ')}. Please improve to avoid penalties.`;
                addNotification(`Low attendance in ${low.map(x=>x.n).join(', ')}`);
            } else banner.classList.add('d-none');
        }

        function toggleDarkMode(el) {
            const on = el.checked;
            if(on) document.body.classList.add('bg-dark','text-light'); else document.body.classList.remove('bg-dark','text-light');
            localStorage.setItem('darkMode', on? '1' : '0');
        }

        function saveSettings() {
            const emailOn = document.getElementById('emailNotifToggle').checked;
            localStorage.setItem('emailNotif', emailOn? '1':'0');
            const md = document.getElementById('darkModeToggle').checked;
            localStorage.setItem('darkMode', md? '1':'0');
            const modal = bootstrap.Modal.getInstance(document.getElementById('profileModal'));
            modal.hide();
        }
    </script>
</body>
</html>